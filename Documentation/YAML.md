# Table of content

- [Table of content](#table-of-content)
- [Introduction](#introduction)
- [YAML for the graph](#yaml-for-the-graph)
  - [`graph:`](#graph)
    - [`options:`](#options)
    - [`structures:`](#structures)
    - [`nodes:`](#nodes)
    - [`edges:`](#edges)
    - [Node description](#node-description)
      - [`node:`](#node)
      - [`kind:`](#kind)
      - [`c-function:`](#c-function)
      - [`unary:`](#unary)
      - [`binary:`](#binary)
      - [`inputs:`](#inputs)
      - [`outputs:`](#outputs)
      - [`args:`](#args)
        - [`literal:`](#literal)
        - [`variable:`](#variable)
  - [Edge description](#edge-description)
    - [`src:`](#src)
    - [`dst:`](#dst)
  - [IO Port Description](#io-port-description)
    - [Normal input or output:](#normal-input-or-output)
    - [`input:` or `output:`](#input-or-output)
    - [`samples:`](#samples)
    - [`type:`](#type)
    - [Input or output list](#input-or-output-list)
  - [YAML for the configuration](#yaml-for-the-configuration)
    - [`schedule-options:`](#schedule-options)
    - [`code-generation-options:`](#code-generation-options)
    - [`c-code-generation-options:`](#c-code-generation-options)
    - [`python-code-generation-options:`](#python-code-generation-options)
    - [`graphviz-code-generation-options:`](#graphviz-code-generation-options)
  - [`version:`](#version)

# Introduction

YAML files are for **tools**. The YAML description is not intended to be written by humans to create a graph. The higher level Python API is much easier to use for that purpose.

YAML files are for exchanging graph descriptions with external tool that may be developed to work with CMSIS-Stream.

Two kind of YAML files are used for the compute graph. The first kind is the graph description that is:

* Defining the nodes
* The API of the nodes
* The implementation to use for the nodes
* The edges and the related FIFOs

The second kind of file is the configuration file controlling how the code generation is done:

* Describing the API of the scheduler
* Describing if the graph is synchronous or asynchronous
* Defining the name of all the files used and / or generated by the tool

The API for YAML import / export is defined in `cmsis_stream.cg.yaml`. 4 functions are provided:

```python
export_graph(g,"graph.yml")
```

```python
export_config(conf,"config.yml")
```

```python
testg = import_graph("graph.yml")
```

```python
testc = import_config("config.yml")
```

For each of the examples in CMSIS-Stream repository, you'll find a YAML file generated by the main python file. It is the easiest way to understand the structure of those YAML files.

# YAML for the graph

The table below explains the top-level elements of the yml graph description.

| Keyword                | Description                                                |
| ---------------------- | ---------------------------------------------------------- |
| [`version:`](#version) | Version of the Compute graph YAML format used by this file |
| [`graph:`](#graph)     | Description of the graph                                   |

## `graph:`

Description of the graph. It contains the following:

| `graph:`                     |              | Content                                                      |
| ---------------------------- | ------------ | ------------------------------------------------------------ |
| [`options:`](#options)       | Optional     | Option to select some default  C++ class for some nodes and edges |
| [`structures:`](#structures) | Optional     | C struct used in the graph for IO description                |
| [`nodes:`](#nodes)           | **Required** | List of nodes in the graph                                   |
| [`edges:`](#edges)           | **Required** | List of edges in the graph                                   |

**Examples:**

```yml
version: '1.0'
graph:
  nodes:
  ...
  edges:
  ...
```

### `options:`

| `options:`   |          | Content                                                      |
| ------------ | -------- | ------------------------------------------------------------ |
| `FIFO:`      | Optional | Name of the C++ class implementing FIFOs in the C++ generated code. (It can be overridden for each edge of the graph) |
| `Duplicate:` | Optional | Name of class used for `Duplicate` node if the default class is not used. |

### `structures:`

List of C structs used in the node description.

This entry is optional in the graph description.

**Examples**

```yml
  structures:
    structure1:
      ...
    structure2:
      ...
```

```yml
  structures:
    complex:
      cname: complex
      bytes: 8
    quaternion:
      cname: quaternion
      bytes: 16
```

Each item in the list has following format:

| Keyword  | Description                                              |
| -------- | -------------------------------------------------------- |
| `cname:` | C name of the structure                                  |
| `bytes:` | Size of the structure in bytes as returned by C `sizeof` |

**Examples**

```yml
- structures:
    complex:
      cname: complex
      bytes: 8
```

### `nodes:`

List of [nodes](#node-description)

**Examples:**

```yml
nodes:
  - node: source
    ...
  - node: processing
    ...
  - node: sink
    ...
```

### `edges:`

List of [edges](#edge-description).

**Examples:**

```yml
edges:
  - src:
      node: source
      ...
    dst:
      node: processing
      ...
  - src:
      node: processing
      ...
    dst:
      node: sink
      ...
```

### Node description

 It contains the following:

| nodes:                       |              | Content                                                      |
| ---------------------------- | ------------ | ------------------------------------------------------------ |
| [`node:`](#node-description) | **Required** | Identification of the node.                                  |
| [`kind:`](#kind)             | Optional     | The category of the node (when implemented with a C++ class) |
| [`c-function:`](#c-function)               | Optional     | A a pure C function |
| [`unary:`](#unary)           | Optional     | Function name for unary function (when node is a pure function with one input and one output) |
| [`binary:`](#binary)         | Optional     | Function name for binary function (when node is a pure function with two inputs and one output) |
| [`inputs:`](#inputs)         | Optional     | List of inputs for this node                                 |
| [`outputs:`](#output)        | Optional     | List of outputs for this node                                |
| [`args:`](#args)             | Optional     |                                                              |

**Examples:**

```yml
- node: processing
    kind: ProcessingNode
    inputs:
    - input: i
      samples: 7
      type: float32_t
    outputs:
    - output: o
      samples: 7
      type: float32_t
```

#### `node:`

Identification of the node. It must be a valid C variable name. It is used to identify the node in the graph and in the generated C code. It must be unique in the graph since it is the only way to identify the node,

#### `kind:`

It is the name of the `C++` class template implementing the node. It must be a valid `C++` class name.

It is optional for `Constant` nodes since those nodes just represent a C variable and don't have a corresponding C implementation.

It is not used for `Dsp`, `Unary` and `Binary` nodes that are mapped to pure C functions. A pure C function has no state and thus do not need a C++ wrapper.

#### `c-function:`

When the node is a pure C function that has no state, there is no C++ wrapper. This `c-function:` field gives the name of a C function and describes how the node IOs and additional arguments are mapped to the arguments of the C function.

This mapping is described with the field `args`:

| args:                       | Required | Content                                                      |
| ---------------------------- | ------------ | ------------------------------------------------------------ |
| `io:` | **Optional** | This argument of the C function uses a FIFO pointer generated by the CMSIS-Stream code generator. |
| `io-length:` | **Optional** | This argument of the C function is the length of a FIFO buffer generated by the CMSIS-Stream code generator. |
| `args:` | **Optional** | This argument of the C function is an additional arguments of the CMSIS-Stream node. |

The FIFO must be defined in the `inputs` or `outputs` sections. The additional arguments must be specified with a `literal` or `variable` section.

| io-length:                       |              | Content                                                      |
| ---------------------------- | ------------ | ------------------------------------------------------------ |
| `name:` | **Required** | Name of the IO                     |
| `sample-unit:` | **Required** | True when the size is expressed in samples. False when the size is expressed in bytes. |

**Examples:**

```yml
- node: myfunc1
    identified: false
    c-function:
      name: myfunc
      args:
      - io: ia
      - io-length:
          name: ia
          sample-unit: true
      - args: 0
      - io: ib
      - io-length:
          name: ib
          sample-unit: false
      - io: o
      - io-length:
          name: o
          sample-unit: true
      - args: 1
      - args: 2
    inputs:
    - input: ia
      samples: 7
      type: float
    - input: ib
      samples: 7
      type: float
    outputs:
    - output: o
      samples: 5
      type: q15_t
    args:
    - variable: testVar
    - literal: 4
    - literal: '5'
```

This will be mapped to the CMSIS-DSP function `myfunc` with header:

```C
  void myfunc(float *i0,
              int    i0_sample_length,
              char  *testVar,
              float *i1,
              int    i1_byte_length,
              q15_t *o2,
              int    o2_sample_length,
              int    arg0,
              char  *arg1);
```

The corresponding CMSIS-Stream node has an input port consuming 7 samples (ia), an input port consuming 7 samples (ib), an output port producing 5 samples (o) and three additional arguments : a variable `testVar`, an int `4` and a string `5`.

The call to the function in the generated C++ code will look like:

```C
myfunc(i0,7,testVar,i1,sizeof(float)*7,o2,5,4,"5");
```

#### `unary:`

When the node is a pure function that has no state and only one input / output, there is no C++ wrapper. This `unary:` field is the name of the function. The C function should implement a specific header.

**Examples:**

```yml
  - node: my_scale1
    unary: my_scale
    inputs:
    - input: i
      samples: 160
      type: float32_t
    outputs:
    - output: o
      samples: 160
      type: float32_t
```

**Header for a unary function:**

```C
void unary(
  const float32_t * pSrc,
        float32_t * pDst,
        uint32_t blockSize);
```

#### `binary:`

When the node is a pure function that has no state, two inputs, one output, there is no C++ wrapper. This `binary:` field is the name of the function. The C function should implement a specific header.

**Examples:**

```yml
  - node: my_binary1
    binary: my_binary
    inputs:
    - input: ia
      samples: 160
      type: float32_t
    - input: ib
      samples: 160
      type: float32_t
    outputs:
    - output: o
      samples: 160
      type: float32_t
```

**Header for a binary function:**

```C
void binary(
  const float32_t * pSrcA,
        float32_t * pSrcB,
        float32_t * pDst,
        uint32_t blockSize);
```

The type of an input argument could just be `float32_t` instead of a pointer. In that case, this input must be connected to a constant node in the graph.

#### `inputs:`

List of [inputs](#input-or-output) for the node.

A source node has no inputs. So this item is optional. 

#### `outputs:`

List of [outputs](#input-or-output) for the node.

A sink node has no outputs. So this item is optional.

#### `args:`

The `C++` implementation can have additional arguments in the constructor. Those arguments are defined with this `args:` field that is optional.

| args:                    |          | Content                  |
| ------------------------ | -------- | ------------------------ |
| [`literal:`](#literal)   | Optional | A scalar or string       |
| [`variable:`](#variable) | Optional | The name of a C variable |

**Examples:**

```yml
args:
    - literal: 4
    - literal: testString
    - variable: someVariable
```

The generated C++ constructor call may look like:

```C++
ProcessingNode<float32_t,7,float32_t,5> processing(fifo0,fifo1,4,"testString",someVariable);
```

##### `literal:`

It can be a scalar (int, float) or a string. I will be passed as it is to the API of the `C++` constructor.

##### `variable:`

It is the name of a C variable.

## Edge description

It contains the following:

| Keyword        |              | Content                                                      |
| -------------- | ------------ | ------------------------------------------------------------ |
| [`src:`](#src) | **Required** | Source port for the edge                                     |
| [`dst:`](#dst) | **Required** | Destination port for the edge                                |
| `class:`       | Optional     | Name of the C++ class template implementing this FIFO. The template arguments must be the same than in original FIFO template. The C++ class must inherit from `FIFOBase` |
| `scale:`       | Optional     | Used in asynchronous scheduling only. It is a float used to scale the synchronous FIFO size to have more margin in asynchronous mode. |

**Examples:**

```yml
- src:
      node: source
      output: o
  dst:
      node: processing
      input: i
```

```yml
- src:
      node: sourceOdd
      output: o
  dst:
      node: debug
      input: i
  class: MyFIFO
  scale: 3.0
```

### `src:`

Source port for an edge. It contains the following:

| `src:`                       | Content                                                     |
| ---------------------------- | ----------------------------------------------------------- |
| [`node:`](#node-description) | Source node                                                 |
| `output:`                    | Name of the [Output port](#io-port-description) of the node |

**Examples:**

```yml
- src:
      node: source
      output: o
```

### `dst:`

Destination port for an edge. It contains the following:

| `dst:`           | Content                                                     |
| ---------------- | ----------------------------------------------------------- |
| [`node:`](#node) | Destination node                                            |
| `input:`         | Name of the [Input port](#io-port-description) for the node |

**Examples:**

```yml
dst:
      node: processing
      input: i
```

## IO Port Description

Description of an IO port on a node. There are two versions. For normal modes it is a list of `input:` or `output:` fields in the YAML.

But for the nodes inheriting from `GenericToManyNode`, `GenericFromManyNode`, `GenericManyToManyNode`, we can have a list of homogeneous inputs or outputs. This must be described in the YAML since those IOs are not managed in the same way in the generated C code.

### Normal input or output:

| Keyword                | Content                                |
| ---------------------- | -------------------------------------- |
| `input:` or `output:`  | Name of the IO port.                   |
| [`samples:`](#samples) | Number of samples produced or consumed |
| [`type:`](#type)       | Data type for the samples              |

**Examples:**

```yml
- input: i
  samples: 7
  type: float32_t
```

```yml
- output: o
  samples: 5
  type: float32_t
```

### `input:` or `output:`

Name of the IO port. It must be a valid Python property name that is not already used by the Python root class.

### `samples:`

Number of samples produced on an output or consumed on an input.

In case of an asynchronous scheduling, it represents the ideal or average case.

In case of cyclo-static scheduling, this is a list encoding the sequence of generated values.

**Examples**

```yml
inputs:
    - input: i
      samples: 800
      type: int16_t
```

For cyclo-static scheduling:

```yml
outputs:
    - output: o
      samples:
      - 185
      - 185
      - 185
      - 180
      type: int16_t
```

### `type:`

Data type for the samples. It can be a scalar data type as defined in CMSIS-DSP:

* `float64_t`
* `float32_t`
* `float16_t`
* `q31_t`
* `q15_t`
* `q7_t`
* `uint32_t`
* `uint16_t`
* `uint8_t`
* `sint32_t`
* `sint16_t`
* `sint8_t`

It can also be more complex datatypes defined with a C struct. More complex datatypes have to be define at the beginning of the graph description using the [`structures:`](#structures) field.

### Input or output list

| Keyword                | Content                                     |
| ---------------------- | ------------------------------------------- |
| [`samples:`](#samples) | Number of samples produced or consumed      |
| [`type:`](#type)       | Data type for the samples                   |
| names:                 | List of input names or list of output names |

**Examples**

```yml
outputs:
      samples: 5
      type: float
      names:
      - oa
      - ob
      - oc
      - od
      - oe
```

In this example, an output list is used. The YAML entry `outputs` is no more containing a list of `output:` entries that would correspond to different kind of output ports.

Here we have a list of output of the same nature : number of samples and types. The `samples:` and `type:` fields are shared between all outputs and only the list of output names is used.

A list of inputs would be described similarly in the `inputs:` section.

When a list of inputs (or list of output) is used, you cannot use any more the `input:` or `output:` entries.

When a list of inputs and/or outputs is used, the node will be recognized (at import) as a special node like `GenericManyToMany` etc ...

## YAML for the configuration

The table below explains the top-level elements of the yml configuration description.

| Keyword                                                      | Description                                                  |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [`version:`](#version)                                       | Version of the Compute graph YAML format used by this file   |
| [`schedule-options:`](#schedule-options)                     | Options used for the computation of the synchronous scheduling |
| [`code-generation-options:`](#code-generation-options)       | Common code generation options                               |
| [`c-code-generation-options:`](#c-code-generation-options)   | Options for the C++ code generation                          |
| [`python-code-generation-options:`](#python-code-generation-options) | Options for the Python code generation                       |
| [`graphviz-code-generation-options:`](#graphviz-code-generation-options) | Options for the graphviz generation                          |

### `schedule-options:`

| Keyword                                                      | Description                                              |
| ------------------------------------------------------------ | -------------------------------------------------------- |
| [`memory-optimization:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/SchedOptions.md#memoryoptimization-default--false) | Enable memory optimization                               |
| [`sink-priority:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/SchedOptions.md#sinkpriority-default--true) | Enable sink prioritization                               |
| [`display-fifo-sizes:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/SchedOptions.md#displayfifosizes-default--false) | Display FIFO sizes during schedule computation           |
| [`dump-schedule:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/SchedOptions.md#dumpschedule-default--false) | Dump the schedule at the end of the schedule computation |

### `code-generation-options:`

| Keyword                                                      | Description                                      |
| ------------------------------------------------------------ | ------------------------------------------------ |
| [`debug-limit:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CodegenOptions.md#debuglimit-default--0) | Number of schedule iterations (used for debug)   |
| [`dump-fifo:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CodegenOptions.md#dumpfifo-default--false) | Dump of FIFO content at runtime (used for debug) |
| [`scheduler-name:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CodegenOptions.md#schedname-default--scheduler) | Name of the scheduler function                   |
| [`fifo-prefix:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CodegenOptions.md#prefix-default--) | Prefix for naming FIFO global buffers.           |

### `c-code-generation-options:`

| Keyword                                                      | Description                                                  |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [`c-optional-args:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#coptionalargs-default--) | Arguments of the C API of the scheduler                      |
| [`switch-case:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#switchcase-default--true) | Don't unroll the schedule. Schedule is implemented as a switch / case |
| [`event-recorder:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#eventrecorder-default--false) | Enable event recorder calls in the generated schedule        |
| [`custom-c-name:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#customcname-default--customh) | Name of the custom include file                              |
| [`post-custom-c-name:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#postcustomcname-default--) | Name of a custom include file following all other include files |
| [`generic-node-c-name:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#genericnodecname-default--genericnodesh) | Name of the include file containing the generic nodes (part of the pack) |
| [`app-nodes-c-name:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#appnodescname-default--appnodesh) | Name of the include file containing the application nodes    |
| [`scheduler-c-file-name:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#schedulercfilename-default--scheduler) | Name of the files containing the code for the scheduler and header for the scheduler |
| [`c-api:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#capi-default--true) | True when the API of the scheduler is callable from C        |
| [`cmsis-dsp:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#cmsisdsp-default--true) | True when CMSIS-DSP headers are included                     |
| [`asynchronous:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#asynchronous-default--false) | True when asynchronous mode is enabled                       |
| [`fifo-increase:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#fifoincrease-default-0) | In asynchronous mode, increase all FIFO sizes globally       |
| [`async-default-skip:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#asyncdefaultskip-default-true) | Behavior of `Duplicate` nodes in asynchronous mode           |
| [`heap-allocation`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#heapallocation-default-false) | Enable the heap allocation mode. When enabled, FIFOs and nodes are allocated on the heap.           |
| [`node-identification`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/CCodeGen.md#nodeidentification-default-false) | When enabled, a new API is generated. This new API enables to identify and access nodes from the outside of the scheduler.           |

### `python-code-generation-options:`

| Keyword                                                      | Description                                   |
| ------------------------------------------------------------ | --------------------------------------------- |
| [`py-optional-args:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/PythonGen.md#pyoptionalargs-default--) | Arguments for the Python API of the scheduler |
| [`custom-python-name:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/PythonGen.md#custompythonname-default--custom) | Name of the custom python file                |
| [`app-nodes-python-name:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/PythonGen.md#appnodespythonname-default--appnodes) | Name of the python application node files     |
| [`scheduler-python-file-name:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/PythonGen.md#schedulerpythonfilename-default--sched) | Name of the python scheduler file             |

### `graphviz-code-generation-options:`

| Keyword                                                      | Description                                     |
| ------------------------------------------------------------ | ----------------------------------------------- |
| [`horizontal:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/GraphvizGen.md#horizontal-default--true) | Horizontal layout for the graph                 |
| [`display-fifo-buf:`](https://github.com/ARM-software/CMSIS-DSP/blob/main/ComputeGraph/documentation/GraphvizGen.md#displayfifobuf-default--false) | Display FIFO buffer ID instead of the FIFO size |

## `version:`

This is a string representing the version of the Compute Graph file format used a YAML file.

It is using semantic versioning.